<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swipe - Cupido</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800">
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="stylesheet" href="assets/styles/main.css">
    <link rel="stylesheet" href="assets/styles/components.css">
    <link rel="stylesheet" href="assets/styles/utilities.css">
    <script src="assets/js/login.js"></script
</head>

<body class="bg-brutalist-dark-pink" style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
    <div class="relative flex size-full min-h-screen flex-col overflow-x-hidden group/design-root">
        <div class="layout-container flex h-full grow flex-col">
            
            <!-- Header -->
            <header class="site-header">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between py-4">
                        <!-- Logo -->
                        <div class="flex items-center gap-3">                     
                            <h1 class="text-2xl sm:text-3xl font-black leading-tight tracking-tighter text-black">
                                <a href="home.html" class="hover:text-[var(--dark-pink-800)] transition-colors">Cupid</a>
                            </h1>
                        </div>
                        
                        <!-- Desktop Navigation -->
                        <nav class="hidden md:flex items-center gap-6">
                            <a class="nav-link" href="discover.html">Home</a>
                            <a class="nav-link" href="swipe.html">Swipe</a>
                            <a class="nav-link" href="messages.html">Messages</a>
                            <a class="nav-link" href="profile.html">Profile</a>
                            <button id="logoutBtn" class="btn-primary">Logout</button>
                        </nav>
                        <!-- Mobile Menu Button -->
                        <div class="md:hidden">
                            <button id="mobile-menu-toggle" class="p-2 text-[var(--dark-pink-800)] hover:text-black" aria-label="Toggle menu">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mobile Menu -->
                    <div id="mobile-menu" class="hidden md:hidden bg-[var(--dark-pink-200)] border-t-2 border-black">
                        <div class="px-4 py-2 space-y-2">
                            <a class="block py-2 text-black hover:text-[var(--dark-pink-800)] transition-colors" href="login.html">Login</a>
                            <a class="block py-2 text-black hover:text-[var(--dark-pink-800)] transition-colors" href="signup.html">Sign Up</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 flex items-center justify-center py-8">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="max-w-md mx-auto">
                        
                        <!-- Loading State -->
                        <div class="text-center py-12" id="loadingState">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--dark-pink-500)]"></div>
                            <p class="mt-2 text-[var(--dark-pink-800)]">Loading profiles...</p>
                        </div>

                        <!-- Error State -->
                        <div class="text-center py-12 hidden" id="errorState">
                            <p class="text-red-600 mb-4">Failed to load profiles. Please try again.</p>
                            <button class="btn-secondary" onclick="loadSwipeProfiles()">Retry</button>
                        </div>

                        <!-- Empty State -->
                        <div class="text-center py-12 hidden" id="emptyState">
                            <h3 class="text-2xl font-bold text-black mb-4">No more profiles!</h3>
                            <p class="text-[var(--dark-pink-800)] mb-4">You've seen all available profiles. Check back later for new matches!</p>
                            <a href="discover.html" class="btn-primary">Browse Discover</a>
                        </div>
                        
                        <!-- Swipe Stack Container -->
                        <div class="relative h-[600px] mb-8 hidden" id="swipeContainer">
                            <!-- Cards will be dynamically inserted here -->
                        </div>
                                    </div>
                                </div>
                                <div class="absolute top-8 left-8 bg-red-500 text-white px-4 py-2 rounded-full font-bold text-lg opacity-0 transition-opacity" id="nopeIndicator3">NOPE</div>
                                <div class="absolute top-8 right-8 bg-green-500 text-white px-4 py-2 rounded-full font-bold text-lg opacity-0 transition-opacity" id="likeIndicator3">LIKE</div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-center gap-6 mb-8">
                            <button id="passBtn" class="w-16 h-16 bg-white border-4 border-red-500 rounded-full flex items-center justify-center hover:bg-red-50 transition-colors">
                                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            
                            <button id="superLikeBtn" class="w-16 h-16 bg-white border-4 border-blue-500 rounded-full flex items-center justify-center hover:bg-blue-50 transition-colors">
                                <svg class="w-8 h-8 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                            </button>
                            
                            <button id="likeBtn" class="w-16 h-16 bg-white border-4 border-green-500 rounded-full flex items-center justify-center hover:bg-green-50 transition-colors">
                                <svg class="w-8 h-8 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </button>
                        </div>

                        <!-- No More Cards Message -->
                        <div id="noMoreCards" class="text-center card p-8 hidden">
                            <div class="mb-4">
                                <svg class="w-16 h-16 mx-auto text-[var(--dark-pink-500)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-black mb-2">That's everyone for now!</h3>
                            <p class="text-[var(--dark-pink-800)] mb-4">Check back later for more profiles, or explore other features.</p>
                            <div class="flex gap-4 justify-center">
                                <a href="discover.html" class="btn-primary">Browse Profiles</a>
                                <a href="messages.html" class="btn-secondary">View Messages</a>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Footer -->
            <footer class="text-center py-6 border-t-2 border-black bg-[var(--dark-pink-200)] bg-opacity-50">
                <div class="container mx-auto px-4 sm:px-6">        
                    <p class="text-sm text-[var(--dark-pink-800)]">
                        Â© 2025 Cupido. All rights reserved. Find love, authentically.
                    </p>
                </div>
            </footer>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="assets/js/main.js"></script>
    <script src="assets/js/api.js"></script>
    <script>
        let profiles = [];
        let currentProfileIndex = 0;
        let cards = [];

        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // Load profiles for swiping
        async function loadSwipeProfiles() {
            try {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('errorState').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('swipeContainer').classList.add('hidden');

                const response = await API.getUsers();
                
                if (!response.ok) {
                    throw new Error('Failed to fetch profiles');
                }

                const data = await response.json();
                profiles = data.users || [];

                if (profiles.length === 0) {
                    showEmptyState();
                    return;
                }

                currentProfileIndex = 0;
                createSwipeCards();
                showSwipeContainer();

            } catch (error) {
                console.error('Error loading profiles:', error);
                showErrorState();
            }
        }

        // Create swipe cards
        function createSwipeCards() {
            const container = document.getElementById('swipeContainer');
            container.innerHTML = '';
            cards = [];

            // Create up to 3 cards for the stack
            for (let i = 0; i < Math.min(3, profiles.length); i++) {
                const profileIndex = currentProfileIndex + i;
                if (profileIndex >= profiles.length) break;

                const card = createCard(profiles[profileIndex], i);
                container.appendChild(card);
                cards.push(card);
            }

            if (cards.length > 0) {
                initializeSwipeListeners();
            }
        }

        // Create individual card
        function createCard(profile, stackIndex) {
            const card = document.createElement('div');
            card.className = `swipe-card absolute inset-0 card overflow-hidden cursor-grab active:cursor-grabbing`;
            card.style.zIndex = -stackIndex;
            
            if (stackIndex === 1) card.classList.add('book-stack-card-2');
            if (stackIndex === 2) card.classList.add('book-stack-card-3');

            card.innerHTML = `
                <img src="${profile.photo_url || 'assets/images/default-avatar.png'}" 
                     alt="${profile.name}" class="w-full h-3/5 object-cover">
                <div class="p-6 h-2/5 flex flex-col justify-between">
                    <div>
                        <h3 class="text-2xl font-bold text-black mb-2">${profile.name}, ${profile.age}</h3>
                        <p class="text-sm text-[var(--dark-pink-800)] mb-2">ð ${profile.city || 'Location not specified'}</p>
                        <p class="text-sm text-black">${profile.about_me || 'No bio available yet.'}</p>
                    </div>
                </div>
                <div class="absolute top-8 left-8 bg-red-500 text-white px-4 py-2 rounded-full font-bold text-lg opacity-0 transition-opacity swipe-indicator-nope">NOPE</div>
                <div class="absolute top-8 right-8 bg-green-500 text-white px-4 py-2 rounded-full font-bold text-lg opacity-0 transition-opacity swipe-indicator-like">LIKE</div>
            `;

            card.dataset.userId = profile.id;
            return card;
        }

        // Initialize swipe listeners
        function initializeSwipeListeners() {
            if (cards.length === 0) return;

            const topCard = cards[0];
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            let currentX = 0;
            let currentY = 0;

            // Mouse events
            topCard.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);

            // Touch events
            topCard.addEventListener('touchstart', startDrag);
            document.addEventListener('touchmove', drag);
            document.addEventListener('touchend', endDrag);

            function startDrag(e) {
                isDragging = true;
                topCard.style.cursor = 'grabbing';
                
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                
                startX = clientX;
                startY = clientY;
            }

            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();

                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                
                currentX = clientX - startX;
                currentY = clientY - startY;

                const rotation = currentX * 0.1;
                topCard.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${rotation}deg)`;

                // Show swipe indicators
                const likeIndicator = topCard.querySelector('.swipe-indicator-like');
                const nopeIndicator = topCard.querySelector('.swipe-indicator-nope');
                
                if (currentX > 50) {
                    likeIndicator.style.opacity = Math.min(1, currentX / 150);
                    nopeIndicator.style.opacity = 0;
                } else if (currentX < -50) {
                    nopeIndicator.style.opacity = Math.min(1, Math.abs(currentX) / 150);
                    likeIndicator.style.opacity = 0;
                } else {
                    likeIndicator.style.opacity = 0;
                    nopeIndicator.style.opacity = 0;
                }
            }

            function endDrag() {
                if (!isDragging) return;
                isDragging = false;
                topCard.style.cursor = 'grab';

                const threshold = 100;
                
                if (Math.abs(currentX) > threshold) {
                    // Swipe detected
                    const direction = currentX > 0 ? 'right' : 'left';
                    handleSwipe(direction);
                } else {
                    // Snap back
                    topCard.style.transform = '';
                    topCard.querySelector('.swipe-indicator-like').style.opacity = 0;
                    topCard.querySelector('.swipe-indicator-nope').style.opacity = 0;
                }

                currentX = 0;
                currentY = 0;
            }
        }

        // Handle swipe action
        function handleSwipe(direction) {
            const topCard = cards[0];
            const userId = topCard.dataset.userId;
            
            // Animate card out
            const finalX = direction === 'right' ? 1000 : -1000;
            topCard.style.transform = `translateX(${finalX}px) rotate(${direction === 'right' ? 30 : -30}deg)`;
            topCard.style.opacity = '0';

            // Log the action (TODO: Send to backend)
            console.log(`${direction === 'right' ? 'Liked' : 'Passed'} user:`, userId);

            // Remove card after animation
            setTimeout(() => {
                topCard.remove();
                cards.shift();
                currentProfileIndex++;

                // Load next card if available
                if (currentProfileIndex + cards.length < profiles.length) {
                    const nextProfile = profiles[currentProfileIndex + cards.length - 1];
                    if (nextProfile) {
                        const newCard = createCard(nextProfile, cards.length);
                        document.getElementById('swipeContainer').appendChild(newCard);
                        cards.push(newCard);
                    }
                }

                // Initialize listeners for new top card
                if (cards.length > 0) {
                    initializeSwipeListeners();
                } else if (currentProfileIndex >= profiles.length) {
                    showEmptyState();
                }

                // Update card positions
                updateCardPositions();
            }, 300);

            if (direction === 'right') {
                // TODO: Handle match logic
                console.log('Potential match!');
            }
        }

        // Update card stack positions
        function updateCardPositions() {
            cards.forEach((card, index) => {
                card.style.zIndex = -index;
                card.className = `swipe-card absolute inset-0 card overflow-hidden cursor-grab active:cursor-grabbing`;
                
                if (index === 1) card.classList.add('book-stack-card-2');
                if (index === 2) card.classList.add('book-stack-card-3');
            });
        }

        // Action button handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Pass button
            document.getElementById('passBtn')?.addEventListener('click', function() {
                if (cards.length > 0) {
                    handleSwipe('left');
                }
            });

            // Like button
            document.getElementById('likeBtn')?.addEventListener('click', function() {
                if (cards.length > 0) {
                    handleSwipe('right');
                }
            });
        });

        // UI state management
        function showErrorState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('swipeContainer').classList.add('hidden');
        }

        function showEmptyState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('swipeContainer').classList.add('hidden');
        }

        function showSwipeContainer() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('swipeContainer').classList.remove('hidden');
        }

        // Mobile menu toggle
        document.getElementById('mobile-menu-toggle').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                logout();
            }
        });

        // Initialize
        loadSwipeProfiles();
    </script>
    <style>
        /* Additional swipe-specific styles */
        .swipe-card {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            transition: all 0.3s ease;
        }
        
        .swipe-card img {
            pointer-events: none;
            user-select: none;
            -webkit-user-drag: none;
        }
        
        #swipeContainer {
            touch-action: none;
            perspective: 1000px;
        }
        
        .card {
            border: 3px solid #2c1810;
            border-radius: 12px;
            background: #f8f6f0;
            position: relative;
        }
        
        /* Book stack effect */
        .swipe-card {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            background: linear-gradient(145deg, #f8f6f0 0%, #ebe7db 100%);
        }
        
        /* Top card (active) */
        .swipe-card:first-child {
            z-index: 3;
            transform: translateY(0px) scale(1);
            box-shadow: 
                0 25px 50px rgba(44, 24, 16, 0.25),
                0 15px 25px rgba(44, 24, 16, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }
        
        /* Second card */
        .book-stack-card-2 {
            z-index: 2 !important;
            transform: translateY(8px) translateX(-4px) scale(0.96) !important;
            box-shadow: 
                0 20px 40px rgba(44, 24, 16, 0.2),
                0 10px 20px rgba(44, 24, 16, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            background: linear-gradient(145deg, #ede9dd 0%, #e0dccf 100%);
            border-color: #3a281f;
        }
        
        /* Third card */
        .book-stack-card-3 {
            z-index: 1 !important;
            transform: translateY(16px) translateX(-8px) scale(0.92) !important;
            box-shadow: 
                0 15px 30px rgba(44, 24, 16, 0.15),
                0 8px 16px rgba(44, 24, 16, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            background: linear-gradient(145deg, #e2dec2 0%, #d5d1c3 100%);
            border-color: #453020;
        }
        
        /* Book spine effect on the side */
        .swipe-card::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, #8b4513, #654321);
            border-radius: 3px 0 0 3px;
            z-index: -1;
        }
        
        .book-stack-card-2::before {
            background: linear-gradient(180deg, #7a3e0f, #563015);
        }
        
        .book-stack-card-3::before {
            background: linear-gradient(180deg, #693509, #4a2611);
        }
        
        /* Book pages effect */
        .swipe-card::after {
            content: '';
            position: absolute;
            right: 2px;
            top: 2px;
            bottom: 2px;
            width: 8px;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(44, 24, 16, 0.1) 2px,
                rgba(44, 24, 16, 0.1) 3px
            );
            border-radius: 0 8px 8px 0;
        }
        
        /* Hover effects for book stack */
        .swipe-card:hover {
            transform: translateY(-2px) scale(1.01);
        }
        
        .book-stack-card-2:hover {
            transform: translateY(6px) translateX(-4px) scale(0.97) !important;
        }
        
        .book-stack-card-3:hover {
            transform: translateY(14px) translateX(-8px) scale(0.93) !important;
        }
    </style>
<script>
let currentCardIndex = 0;
const cards = ['card1', 'card2', 'card3', 'card4', 'card5']; // Added more cards
let isDragging = false;
let startX = 0;
let currentX = 0;
let cardBeingDragged = null;

let profiles = [];
let profileIndex = 0;
let offset = 0;
const limit = 20; // Increased batch size
let userGender = 'female'; // This should be set based on user's preference

// Mobile menu toggle
const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
const mobileMenu = document.getElementById('mobile-menu');

if (mobileMenuToggle && mobileMenu) {
    mobileMenuToggle.addEventListener('click', function () {
        mobileMenu.classList.toggle('hidden');
    });

    document.addEventListener('click', function (e) {
        if (!mobileMenu.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
            mobileMenu.classList.add('hidden');
        }
    });
}

// Button event listeners
document.getElementById('passBtn').addEventListener('click', () => swipeCard('left'));
document.getElementById('likeBtn').addEventListener('click', () => swipeCard('right'));
document.getElementById('superLikeBtn').addEventListener('click', () => swipeCard('up'));

// Touch/Mouse events for swipe functionality
function initializeCardEvents() {
    cards.forEach(cardId => {
        const card = document.getElementById(cardId);
        if (!card) return;

        // Mouse events
        card.addEventListener('mousedown', startDrag, { passive: false });
        document.addEventListener('mousemove', drag, { passive: false });
        document.addEventListener('mouseup', endDrag);

        // Touch events
        card.addEventListener('touchstart', startDrag, { passive: false });
        card.addEventListener('touchmove', drag, { passive: false });
        card.addEventListener('touchend', endDrag);
    });
}

initializeCardEvents();

function startDrag(e) {
    const targetCard = e.target.closest('.swipe-card');
    if (!targetCard || targetCard.id !== cards[currentCardIndex]) return;

    e.preventDefault();
    isDragging = true;
    cardBeingDragged = targetCard;

    const clientX = e.type === 'mousedown' ? e.clientX :
        e.touches && e.touches[0] ? e.touches[0].clientX : 0;
    startX = clientX;

    if (cardBeingDragged) {
        cardBeingDragged.style.transition = 'none';
        cardBeingDragged.style.cursor = 'grabbing';
        cardBeingDragged.style.zIndex = '1000'; // Bring to front while dragging
    }
}

function drag(e) {
    if (!isDragging || !cardBeingDragged) return;

    e.preventDefault();

    const clientX = e.type === 'mousemove' ? e.clientX :
        e.touches && e.touches[0] ? e.touches[0].clientX : 0;
    currentX = clientX - startX;

    const rotation = currentX * 0.1;
    const lift = Math.abs(currentX) * 0.2;

    cardBeingDragged.style.transform = `translateX(${currentX}px) translateY(-${lift}px) rotate(${rotation}deg) scale(1.05)`;
    cardBeingDragged.style.boxShadow = `
        0 ${30 + lift}px ${60 + lift}px rgba(44, 24, 16, 0.3),
        0 ${20 + lift}px ${30 + lift}px rgba(44, 24, 16, 0.2)
    `;

    // Show indicators based on swipe direction
    const likeIndicator = cardBeingDragged.querySelector('[id^="likeIndicator"]');
    const nopeIndicator = cardBeingDragged.querySelector('[id^="nopeIndicator"]');

    if (likeIndicator && nopeIndicator) {
        if (currentX > 50) {
            likeIndicator.style.opacity = Math.min(1, (currentX - 50) / 100);
            nopeIndicator.style.opacity = 0;
        } else if (currentX < -50) {
            nopeIndicator.style.opacity = Math.min(1, (-currentX - 50) / 100);
            likeIndicator.style.opacity = 0;
        } else {
            likeIndicator.style.opacity = 0;
            nopeIndicator.style.opacity = 0;
        }
    }
}

function endDrag(e) {
    if (!isDragging || !cardBeingDragged) return;

    isDragging = false;

    if (cardBeingDragged) {
        cardBeingDragged.style.cursor = 'grab';

        if (Math.abs(currentX) > 100) {
            // Complete the swipe
            const direction = currentX > 0 ? 'right' : 'left';
            completeSwipe(cardBeingDragged, direction);
        } else {
            // Snap back to original position
            cardBeingDragged.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
            cardBeingDragged.style.transform = getCardStackTransform(currentCardIndex);
            cardBeingDragged.style.boxShadow = `
                0 25px 50px rgba(44, 24, 16, 0.25),
                0 15px 25px rgba(44, 24, 16, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.6)
            `;

            // Hide indicators
            const likeIndicator = cardBeingDragged.querySelector('[id^="likeIndicator"]');
            const nopeIndicator = cardBeingDragged.querySelector('[id^="nopeIndicator"]');
            if (likeIndicator) likeIndicator.style.opacity = 0;
            if (nopeIndicator) nopeIndicator.style.opacity = 0;
        }
    }

    cardBeingDragged = null;
    currentX = 0;
}

function swipeCard(direction) {
    const currentCard = document.getElementById(cards[currentCardIndex]);
    completeSwipe(currentCard, direction);
}

function completeSwipe(card, direction) {
    const translateX = direction === 'right' ? '150vw' : direction === 'left' ? '-150vw' : '0';
    const translateY = direction === 'up' ? '-150vh' : '0';
    const rotation = direction === 'right' ? '45deg' : direction === 'left' ? '-45deg' : '0';

    card.style.transition = 'transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.6s ease';
    card.style.transform = `translateX(${translateX}) translateY(${translateY}) rotate(${rotation}) scale(0.8)`;
    card.style.opacity = '0';
    card.style.zIndex = '-1';

    // Update stats
    updateStats(direction);

    setTimeout(() => {
        // Completely remove the card from view and reset for future use
        card.style.display = 'none';
        card.style.transition = '';
        card.style.transform = '';
        card.style.opacity = '1';
        card.style.zIndex = '';
        moveToNextCard();
    }, 600);
}

function getCardStackTransform(cardIndex) {
    const stackPosition = cardIndex - currentCardIndex;
    
    if (stackPosition === 0) {
        return 'translateY(0px) scale(1)';
    } else if (stackPosition === 1) {
        return 'translateY(8px) translateX(-4px) scale(0.96)';
    } else if (stackPosition === 2) {
        return 'translateY(16px) translateX(-8px) scale(0.92)';
    } else if (stackPosition === 3) {
        return 'translateY(24px) translateX(-12px) scale(0.88)';
    } else {
        return 'translateY(32px) translateX(-16px) scale(0.84)';
    }
}

function moveToNextCard() {
    // Move to next profile
    profileIndex++;
    currentCardIndex++;

    // Check if we need to load more profiles
    if (profileIndex >= profiles.length - 2) {
        loadMoreProfiles();
    }

    // If we've run out of cards in the DOM, cycle back to the first ones
    if (currentCardIndex >= cards.length) {
        currentCardIndex = 0;
    }

    // Check if we have more profiles to show
    if (profileIndex >= profiles.length) {
        // Show no more cards message
        document.getElementById('swipeContainer').style.display = 'none';
        document.getElementById('noMoreCards').classList.remove('hidden');
        return;
    }

    // Update all visible cards
    updateCardStack();
    
    // Preload the next card if available
    preloadNextCard();
}

function updateCardStack() {
    for (let i = 0; i < cards.length; i++) {
        const card = document.getElementById(cards[i]);
        const profileIdx = profileIndex + i;
        
        if (profileIdx < profiles.length) {
            updateCardContent(cards[i], profiles[profileIdx]);
            card.style.display = 'block';
            card.style.zIndex = cards.length - i;
            card.style.transform = getCardStackTransform(i);
        } else {
            card.style.display = 'none';
        }
    }
}

async function updateCardContent(cardId, profile) {
    const card = document.getElementById(cardId);
    if (!card) return;

    const nameElement = card.querySelector('h3');
    const locationElement = card.querySelector('p');
    const bioElement = card.querySelectorAll('p')[1];
    const imageElement = card.querySelector('img');

    if (nameElement) nameElement.textContent = `${profile.name}, ${profile.age || Math.floor(Math.random() * 20) + 20}`;
    if (locationElement) locationElement.textContent = `ð ${profile.location || 'Unknown'}`;
    if (bioElement) bioElement.textContent = profile.bio || generateRandomBio();

    // Set gender-appropriate random profile image
    if (imageElement) {
        const gender = userGender === 'male' ? 'women' : 'men'; // Show opposite gender
        const randomId = Math.floor(Math.random() * 99) + 1;
        imageElement.src = `https://randomuser.me/api/portraits/${gender}/${randomId}.jpg`;
        imageElement.onerror = function() {
            // Fallback to a different random image if one fails
            const fallbackId = Math.floor(Math.random() * 50) + 1;
            this.src = `https://randomuser.me/api/portraits/${gender}/${fallbackId}.jpg`;
        };
    }

    card.style.opacity = '1';

    // Reset indicators opacity
    const likeIndicator = card.querySelector('[id^="likeIndicator"]');
    const nopeIndicator = card.querySelector('[id^="nopeIndicator"]');
    if (likeIndicator) likeIndicator.style.opacity = 0;
    if (nopeIndicator) nopeIndicator.style.opacity = 0;
}

function generateRandomBio() {
    const bios = [
        "Love hiking and outdoor adventures ðï¸",
        "Coffee enthusiast and bookworm ðâ",
        "Yoga instructor seeking zen moments ð§ââï¸",
        "Foodie exploring new cuisines ð",
        "Dog lover and weekend explorer ð",
        "Artist painting life in vibrant colors ð¨",
        "Music lover with eclectic taste ðµ",
        "Travel addict collecting memories âï¸",
        "Fitness enthusiast staying active ðª",
        "Beach lover chasing sunsets ð"
    ];
    return bios[Math.floor(Math.random() * bios.length)];
}

async function fetchProfiles(limit = 20, offset = 0) {
    try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
            // Generate mock profiles if no token (for demo purposes)
            return generateMockProfiles(limit);
        }

        const response = await fetch(`http://localhost:8080/getuserswipe?limit=${limit}&offset=${offset}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success && Array.isArray(data.data) && data.data.length > 0) {
            return data.data;
        } else {
            return generateMockProfiles(limit);
        }
    } catch (err) {
        console.error('Fetch profiles error:', err);
        return generateMockProfiles(limit);
    }
}

function generateMockProfiles(count) {
    const names = ['Alex', 'Jordan', 'Taylor', 'Casey', 'Morgan', 'Riley', 'Avery', 'Quinn', 'Sage', 'River'];
    const cities = ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio'];
    
    const mockProfiles = [];
    for (let i = 0; i < count; i++) {
        mockProfiles.push({
            name: names[Math.floor(Math.random() * names.length)],
            age: Math.floor(Math.random() * 20) + 20,
            location: cities[Math.floor(Math.random() * cities.length)],
            bio: generateRandomBio()
        });
    }
    return mockProfiles;
}

async function loadInitialProfiles() {
    profiles = await fetchProfiles(limit, offset);
    offset += profiles.length;

    if (profiles.length === 0) {
        document.getElementById('swipeContainer').style.display = 'none';
        document.getElementById('noMoreCards').classList.remove('hidden');
        return;
    }

    profileIndex = 0;
    currentCardIndex = 0;

    // Initialize all cards with profiles
    updateCardStack();
}

async function loadMoreProfiles() {
    const newProfiles = await fetchProfiles(limit, offset);
    offset += newProfiles.length;

    if (newProfiles.length > 0) {
        profiles = profiles.concat(newProfiles);
    }
}

function preloadNextCard() {
    // Preload the image for smoother experience
    const nextProfileIndex = profileIndex + cards.length;
    if (nextProfileIndex < profiles.length) {
        const gender = userGender === 'male' ? 'women' : 'men';
        const randomId = Math.floor(Math.random() * 99) + 1;
        const img = new Image();
        img.src = `https://randomuser.me/api/portraits/${gender}/${randomId}.jpg`;
    }
}

function updateStats(direction) {
    try {
        const swipesLeftElement = document.getElementById('swipesLeft');
        const likesCountElement = document.getElementById('likesCount');
        const matchesCountElement = document.getElementById('matchesCount');

        if (swipesLeftElement) {
            let swipesLeft = parseInt(swipesLeftElement.textContent) || 0;
            swipesLeft = Math.max(0, swipesLeft - 1);
            swipesLeftElement.textContent = swipesLeft;
        }

        if (direction === 'right' || direction === 'up') {
            if (likesCountElement) {
                let likesCount = parseInt(likesCountElement.textContent) || 0;
                likesCount++;
                likesCountElement.textContent = likesCount;
            }

            // Random chance of match (30% chance)
            if (Math.random() > 0.7 && matchesCountElement) {
                let matchesCount = parseInt(matchesCountElement.textContent) || 0;
                matchesCount++;
                matchesCountElement.textContent = matchesCount;

                // Show match notification
                setTimeout(() => {
                    alert('It\'s a Match! ð You can now start chatting.');
                }, 700);
            }
        }
    } catch (error) {
        console.error('Error updating stats:', error);
    }
}

// Set user gender preference (you should set this based on user's actual preference)
function setUserGender(gender) {
    userGender = gender; // 'male' or 'female'
}

// Prevent default drag behavior on images
document.querySelectorAll('img').forEach(img => {
    img.addEventListener('dragstart', e => e.preventDefault());
});

// Logout functionality
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
    logoutBtn.addEventListener('click', function () {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('token');
            sessionStorage.removeItem('token');
            window.location.href = 'login.html';
        }
    });
}

// Keyboard shortcuts for better UX
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        swipeCard('left');
    } else if (e.key === 'ArrowRight') {
        swipeCard('right');
    } else if (e.key === 'ArrowUp') {
        swipeCard('up');
    }
});

// Load initial profiles on page load
window.addEventListener('DOMContentLoaded', () => {
    loadInitialProfiles();
});
</script>
</body>
</html>
