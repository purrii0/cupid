<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile - Cupid</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800">
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="stylesheet" href="assets/styles/main.css">
    <link rel="stylesheet" href="assets/styles/components.css">
    <link rel="stylesheet" href="assets/styles/utilities.css">
</head>

<body class="bg-brutalist-dark-pink" style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
    <!-- Loading State -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="loadingOverlay">
        <div class="bg-white rounded-lg p-6 flex items-center gap-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--dark-pink-500)]"></div>
            <span class="text-black font-semibold">Loading...</span>
        </div>
    </div>
    <div class="relative flex size-full min-h-screen flex-col overflow-x-hidden group/design-root">
        <div class="layout-container flex h-full grow flex-col">

            <!-- Main Content -->
            <main class="flex-1">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="max-w-4xl mx-auto">
                        
                        <!-- Page Header -->
                            <div class="flex items-center justify-between mb-8">
                            <div>
                                <h1 class="text-3xl font-black text-black mb-2">Edit Profile</h1>
                                <p class="text-[var(--dark-pink-800)]">Update your profile information and preferences</p>
                            </div>
                            <div class="flex gap-4">
                                <button onclick="loadCurrentProfile()" class="btn-secondary" type="button">Reload Data</button>
                                <a href="profile.html" class="btn-secondary">
                                    Back to Profile
                                </a>
                            </div>
                        </div>                        <!-- Edit Form -->
                        <form id="profile-form" class="space-y-8">
                            
                            <!-- Profile Picture Section -->
                            <div class="card p-8">
                                <h2 class="text-2xl font-bold text-black mb-6">Profile Picture</h2>
                                <div class="flex flex-col md:flex-row items-center gap-8">
                                    <div class="relative">
                                        <img id="profile-picture" src="assets/images/default-avatar.png" alt="Your Profile" class="w-32 h-32 rounded-full object-cover border-4 border-black">
                                        <button type="button" id="upload-picture-btn" class="absolute bottom-0 right-0 w-10 h-10 bg-[var(--dark-pink-500)] text-white rounded-full flex items-center justify-center border-2 border-black hover:bg-[var(--dark-pink-600)] transition-colors">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </button>
                                        <input type="file" id="picture-input" accept="image/*" class="hidden">
                                    </div>
                                    <div class="text-center md:text-left">
                                        <p class="text-[var(--dark-pink-800)] mb-2">Upload a new profile picture</p>
                                        <p class="text-sm text-[var(--dark-pink-600)]">JPG, PNG or GIF (max. 5MB)</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Basic Information -->
                            <div class="card p-8">
                                <h2 class="text-2xl font-bold text-black mb-6">Basic Information</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="first-name" class="block text-black font-semibold mb-2">First Name</label>
                                        <input type="text" id="first-name" name="first-name" class="w-full p-3 border-2 border-black rounded text-black" required>
                                    </div>
                                    <div>
                                        <label for="last-name" class="block text-black font-semibold mb-2">Last Name</label>
                                        <input type="text" id="last-name" name="last-name" class="w-full p-3 border-2 border-black rounded text-black" required>
                                    </div>
                                    <div>
                                        <label for="age" class="block text-black font-semibold mb-2">Age</label>
                                        <input type="number" id="age" name="age" min="18" max="100" class="w-full p-3 border-2 border-black rounded text-black" required>
                                    </div>
                                    <div>
                                        <label for="location" class="block text-black font-semibold mb-2">Location</label>
                                        <input type="text" id="location" name="location" class="w-full p-3 border-2 border-black rounded text-black" required>
                                    </div>
                                    <div>
                                        <label for="height" class="block text-black font-semibold mb-2">Height</label>
                                        <input type="text" id="height" name="height" placeholder="e.g., 5'10&quot; or 178cm" class="w-full p-3 border-2 border-black rounded text-black">
                                    </div>
                                    <div>
                                        <label for="occupation" class="block text-black font-semibold mb-2">Occupation</label>
                                        <input type="text" id="occupation" name="occupation" class="w-full p-3 border-2 border-black rounded text-black">
                                    </div>
                                </div>
                            </div>

                            <!-- About Me -->
                            <div class="card p-8">
                                <h2 class="text-2xl font-bold text-black mb-6">About Me</h2>
                                <div>
                                    <label for="about" class="block text-black font-semibold mb-2">Tell others about yourself</label>
                                    <textarea id="about" name="about" rows="6" class="w-full p-3 border-2 border-black rounded text-[var(--dark-pink-800)] resize-none" placeholder="Share your interests, hobbies, and what you're looking for..."></textarea>
                                    <p class="text-sm text-[var(--dark-pink-600)] mt-2">Maximum 500 characters</p>
                                </div>
                            </div>

                            <!-- Preferences -->
                            <div class="card p-8">
                                <h2 class="text-2xl font-bold text-black mb-6">Preferences</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="education" class="block text-black font-semibold mb-2">Education</label>
                                        <select id="education" name="education" class="w-full p-3 border-2 border-black rounded text-black">
                                            <option value="High School">High School</option>
                                            <option value="Some College">Some College</option>
                                            <option value="Associate's Degree">Associate's Degree</option>
                                            <option value="Bachelor's Degree" selected>Bachelor's Degree</option>
                                            <option value="Master's Degree">Master's Degree</option>
                                            <option value="PhD">PhD</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="relationship-status" class="block text-black font-semibold mb-2">Relationship Status</label>
                                        <select id="relationship-status" name="relationship-status" class="w-full p-3 border-2 border-black rounded text-black">
                                            <option value="Single" selected>Single</option>
                                            <option value="Divorced">Divorced</option>
                                            <option value="Widowed">Widowed</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="looking-for" class="block text-black font-semibold mb-2">Looking For</label>
                                        <select id="looking-for" name="looking-for" class="w-full p-3 border-2 border-black rounded text-black">
                                            <option value="Casual">Casual Dating</option>
                                            <option value="Long-term" selected>Long-term Relationship</option>
                                            <option value="Marriage">Marriage</option>
                                            <option value="Friendship">Friendship</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Interests -->
                            <div class="card p-8">
                                <h2 class="text-2xl font-bold text-black mb-6">Interests</h2>
                                <p class="text-[var(--dark-pink-800)] mb-4">Select up to 8 interests that represent you</p>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Photography" class="hidden">
                                        <span class="interest-tag">📸 Photography</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Hiking" class="hidden">
                                        <span class="interest-tag">🥾 Hiking</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Travel" class="hidden">
                                        <span class="interest-tag">✈️ Travel</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Foodie" class="hidden">
                                        <span class="interest-tag">🍕 Foodie</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Music" class="hidden">
                                        <span class="interest-tag">🎵 Music</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Running" class="hidden">
                                        <span class="interest-tag">🏃‍♂️ Running</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Reading" class="hidden">
                                        <span class="interest-tag">📚 Reading</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Gaming" class="hidden">
                                        <span class="interest-tag">🎮 Gaming</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Art" class="hidden">
                                        <span class="interest-tag">🎨 Art</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Movies" class="hidden">
                                        <span class="interest-tag">🎬 Movies</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Dancing" class="hidden">
                                        <span class="interest-tag">💃 Dancing</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Cooking" class="hidden">
                                        <span class="interest-tag">👨‍🍳 Cooking</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Fitness" class="hidden">
                                        <span class="interest-tag">💪 Fitness</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Nature" class="hidden">
                                        <span class="interest-tag">🌿 Nature</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Technology" class="hidden">
                                        <span class="interest-tag">💻 Technology</span>
                                    </label>
                                    <label class="interest-checkbox cursor-pointer">
                                        <input type="checkbox" name="interests" value="Yoga" class="hidden">
                                        <span class="interest-tag">🧘‍♀️ Yoga</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Photos -->
                            <div class="card p-8">
                                <h2 class="text-2xl font-bold text-black mb-6">Additional Photos</h2>
                                <p class="text-[var(--dark-pink-800)] mb-4">Upload up to 6 additional photos to showcase your personality</p>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="photo-slot aspect-square bg-gray-200 border-2 border-black rounded-lg overflow-hidden relative">
                                        <img src="assets/images/default-avatar.png" alt="Photo 1" class="w-full h-full object-cover">
                                        <button type="button" class="absolute top-2 right-2 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="photo-slot aspect-square bg-gray-200 border-2 border-black rounded-lg overflow-hidden relative">
                                        <img src="assets/images/default-avatar.png" alt="Photo 2" class="w-full h-full object-cover">
                                        <button type="button" class="absolute top-2 right-2 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="photo-slot aspect-square bg-[var(--dark-pink-100)] border-2 border-dashed border-[var(--dark-pink-500)] rounded-lg flex items-center justify-center cursor-pointer hover:bg-[var(--dark-pink-200)] transition-colors">
                                        <div class="text-center">
                                            <svg class="w-8 h-8 text-[var(--dark-pink-500)] mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            <p class="text-sm text-[var(--dark-pink-600)]">Add Photo</p>
                                        </div>
                                        <input type="file" accept="image/*" class="hidden">
                                    </div>
                                    <div class="photo-slot aspect-square bg-[var(--dark-pink-100)] border-2 border-dashed border-[var(--dark-pink-500)] rounded-lg flex items-center justify-center cursor-pointer hover:bg-[var(--dark-pink-200)] transition-colors">
                                        <div class="text-center">
                                            <svg class="w-8 h-8 text-[var(--dark-pink-500)] mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            <p class="text-sm text-[var(--dark-pink-600)]">Add Photo</p>
                                        </div>
                                        <input type="file" accept="image/*" class="hidden">
                                    </div>
                                    <div class="photo-slot aspect-square bg-[var(--dark-pink-100)] border-2 border-dashed border-[var(--dark-pink-500)] rounded-lg flex items-center justify-center cursor-pointer hover:bg-[var(--dark-pink-200)] transition-colors">
                                        <div class="text-center">
                                            <svg class="w-8 h-8 text-[var(--dark-pink-500)] mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            <p class="text-sm text-[var(--dark-pink-600)]">Add Photo</p>
                                        </div>
                                        <input type="file" accept="image/*" class="hidden">
                                    </div>
                                    <div class="photo-slot aspect-square bg-[var(--dark-pink-100)] border-2 border-dashed border-[var(--dark-pink-500)] rounded-lg flex items-center justify-center cursor-pointer hover:bg-[var(--dark-pink-200)] transition-colors">
                                        <div class="text-center">
                                            <svg class="w-8 h-8 text-[var(--dark-pink-500)] mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            <p class="text-sm text-[var(--dark-pink-600)]">Add Photo</p>
                                        </div>
                                        <input type="file" accept="image/*" class="hidden">
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-4 justify-between">
                                <a href="profile.html" class="btn-secondary text-center">Cancel</a>
                                <div class="flex gap-4">
                                    <button type="submit" class="btn-primary">Save Changes</button>
                                </div>
                            </div>

                        </form>
                    </div>
                </div>
            </main>

        </div>
    </div>

    <!-- JavaScript -->
    <script src="assets/js/main.js"></script>
    <script>
        // Profile picture upload
        document.getElementById('upload-picture-btn').addEventListener('click', function() {
            document.getElementById('picture-input').click();
        });

        document.getElementById('picture-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('File size must be less than 5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profile-picture').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Interest selection
        document.querySelectorAll('.interest-checkbox').forEach(label => {
            const checkbox = label.querySelector('input[type="checkbox"]');
            const tag = label.querySelector('.interest-tag');
            
            function updateTag() {
                if (checkbox.checked) {
                    tag.classList.add('selected');
                } else {
                    tag.classList.remove('selected');
                }
            }
            
            updateTag(); // Initialize
            
            label.addEventListener('click', function() {
                const checkedCount = document.querySelectorAll('input[name="interests"]:checked').length;
                
                if (!checkbox.checked && checkedCount >= 8) {
                    alert('You can select up to 8 interests only');
                    return;
                }
                
                checkbox.checked = !checkbox.checked;
                updateTag();
            });
        });
    </script>

    <style>
        .interest-tag {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: var(--dark-pink-200);
            border: 2px solid black;
            color: black;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 9999px;
            transition: all 0.2s;
        }
        
        .interest-tag.selected {
            background-color: var(--dark-pink-500);
            color: white;
        }
        
        .interest-tag:hover {
            background-color: var(--dark-pink-300);
        }
        
        .interest-tag.selected:hover {
            background-color: var(--dark-pink-600);
        }
    </style>

    <!-- JavaScript -->
    <script src="assets/js/main.js"></script>
    <script src="assets/js/api.js"></script>
    <script>
        let currentUser = null;

        // Utility function to show messages
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded border-2 border-black font-semibold z-50 ${
                type === 'success' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'
            }`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            if (!isAuthenticated()) {
                console.log('User not authenticated, redirecting...');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('User is authenticated, initializing...');
            
            // Initialize form first, then load profile data
            initializeForm();
            
            // Add a small delay to ensure everything is ready
            setTimeout(() => {
                loadCurrentProfile();
            }, 500);
        });

        // Load current user profile
        async function loadCurrentProfile() {
            try {
                console.log('Starting to load profile...');
                showLoading();
                
                const response = await API.getUserProfile();
                console.log('API response:', response);
                
                if (!response || !response.ok) {
                    console.error('Failed to fetch profile, response:', response);
                    throw new Error('Failed to fetch profile');
                }

                const data = await response.json();
                console.log('Profile data received:', data);
                
                currentUser = data.user || data;
                console.log('Current user set to:', currentUser);
                
                if (currentUser) {
                    populateForm(currentUser);
                } else {
                    console.error('No user data found in response');
                    showMessage('No profile data found', 'error');
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error loading profile:', error);
                showMessage('Failed to load profile data: ' + error.message, 'error');
                hideLoading();
            }
        }

        // Populate form with current user data
        function populateForm(user) {
            console.log('Populating form with user data:', user);
            
            // Split name into first and last name
            const nameParts = (user.name || '').split(' ');
            document.getElementById('first-name').value = nameParts[0] || '';
            document.getElementById('last-name').value = nameParts.slice(1).join(' ') || '';
            
            // Basic information
            document.getElementById('age').value = user.age || '';
            document.getElementById('location').value = user.city || user.location || '';
            document.getElementById('height').value = user.height || '';
            document.getElementById('occupation').value = user.occupation || '';
            
            // About me
            document.getElementById('about').value = user.about_me || user.bio || '';
            
            // Preferences
            if (user.education) {
                document.getElementById('education').value = user.education;
            }
            if (user.relationship_status) {
                document.getElementById('relationship-status').value = user.relationship_status;
            }
            if (user.looking_for) {
                document.getElementById('looking-for').value = user.looking_for;
            }
            
            // Profile picture
            if (user.photo_url && user.photo_url !== 'assets/images/default-avatar.png') {
                document.getElementById('profile-picture').src = user.photo_url;
            }
            
            // Clear all interests first
            const interestCheckboxes = document.querySelectorAll('input[name="interests"]');
            interestCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.nextElementSibling.classList.remove('selected');
            });
            
            // Set user's interests
            if (user.hobbies) {
                const userInterests = user.hobbies.split(',').map(h => h.trim());
                console.log('User interests:', userInterests);
                
                interestCheckboxes.forEach(checkbox => {
                    if (userInterests.includes(checkbox.value)) {
                        checkbox.checked = true;
                        checkbox.nextElementSibling.classList.add('selected');
                    }
                });
            }
            
            console.log('Form populated successfully');
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function initializeForm() {
            // Interest selection handling
            const interestCheckboxes = document.querySelectorAll('.interest-checkbox');
            interestCheckboxes.forEach(label => {
                label.addEventListener('click', function() {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    const tag = this.querySelector('.interest-tag');
                    
                    checkbox.checked = !checkbox.checked;
                    
                    if (checkbox.checked) {
                        tag.classList.add('selected');
                    } else {
                        tag.classList.remove('selected');
                    }
                    
                    // Limit to 8 interests
                    const checkedCount = document.querySelectorAll('input[name="interests"]:checked').length;
                    if (checkedCount > 8) {
                        checkbox.checked = false;
                        tag.classList.remove('selected');
                        showMessage('You can select maximum 8 interests', 'error');
                    }
                });
            });

            // Photo upload handling
            const uploadBtn = document.getElementById('upload-picture-btn');
            const fileInput = document.getElementById('picture-input');
            
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        showMessage('File size must be less than 5MB', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('profile-picture').src = e.target.result;
                        showMessage('Photo selected! Save your profile to apply changes.', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Form submission handling
            document.getElementById('profile-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validate form
                const requiredFields = ['first-name', 'last-name', 'age', 'location'];
                let isValid = true;
                
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('border-red-500');
                        showMessage(`${field.previousElementSibling.textContent} is required`, 'error');
                    } else {
                        field.classList.remove('border-red-500');
                    }
                });
                
                if (!isValid) {
                    return;
                }
                
                // Check interests count
                const selectedInterests = document.querySelectorAll('input[name="interests"]:checked');
                if (selectedInterests.length === 0) {
                    showMessage('Please select at least one interest', 'error');
                    return;
                }
                
                try {
                    showLoading();
                    
                    // Prepare form data
                    const firstName = document.getElementById('first-name').value.trim();
                    const lastName = document.getElementById('last-name').value.trim();
                    const fullName = `${firstName} ${lastName}`.trim();
                    
                    const formData = {
                        name: fullName,
                        age: parseInt(document.getElementById('age').value),
                        city: document.getElementById('location').value.trim(),
                        height: document.getElementById('height').value.trim(),
                        occupation: document.getElementById('occupation').value.trim(),
                        about_me: document.getElementById('about').value.trim(),
                        education: document.getElementById('education').value,
                        relationship_status: document.getElementById('relationship-status').value,
                        looking_for: document.getElementById('looking-for').value,
                        hobbies: Array.from(selectedInterests).map(cb => cb.value).join(', ')
                    };
                    
                    // Update profile via API
                    const response = await API.updateProfile(formData);
                    
                    if (!response || !response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to update profile');
                    }
                    
                    hideLoading();
                    showMessage('Profile updated successfully!', 'success');
                    
                    // Clear draft since profile was successfully saved
                    localStorage.removeItem('profileDraft');
                    
                    // Redirect to profile page after a short delay
                    setTimeout(() => {
                        window.location.href = 'profile.html';
                    }, 1500);
                    
                } catch (error) {
                    console.error('Error updating profile:', error);
                    hideLoading();
                    showMessage(error.message || 'Failed to update profile', 'error');
                }
            });

            // Save draft functionality
            document.getElementById('save-draft-btn').addEventListener('click', function() {
                const formData = {
                    firstName: document.getElementById('first-name').value,
                    lastName: document.getElementById('last-name').value,
                    age: document.getElementById('age').value,
                    location: document.getElementById('location').value,
                    height: document.getElementById('height').value,
                    occupation: document.getElementById('occupation').value,
                    about: document.getElementById('about').value,
                    education: document.getElementById('education').value,
                    relationshipStatus: document.getElementById('relationship-status').value,
                    lookingFor: document.getElementById('looking-for').value,
                    interests: Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(cb => cb.value)
                };
                
                // Save to localStorage as draft
                localStorage.setItem('profileDraft', JSON.stringify(formData));
                showMessage('Draft saved successfully!', 'success');
            });

            // Character counter for about section
            const aboutTextarea = document.getElementById('about');
            const maxLength = 500;
            
            function updateCharCount() {
                const currentLength = aboutTextarea.value.length;
                let charCountElement = aboutTextarea.nextElementSibling;
                
                // If the next element is not the char count, create it
                if (!charCountElement || !charCountElement.textContent.includes('characters')) {
                    charCountElement = document.createElement('p');
                    charCountElement.className = 'text-sm text-[var(--dark-pink-600)] mt-2';
                    aboutTextarea.parentNode.insertBefore(charCountElement, aboutTextarea.nextSibling);
                }
                
                charCountElement.textContent = `${currentLength}/${maxLength} characters`;
                
                if (currentLength > maxLength) {
                    charCountElement.classList.add('text-red-600');
                    aboutTextarea.classList.add('border-red-500');
                } else {
                    charCountElement.classList.remove('text-red-600');
                    aboutTextarea.classList.remove('border-red-500');
                }
            }
            
            aboutTextarea.addEventListener('input', updateCharCount);
            updateCharCount(); // Initialize

            // Load draft after profile data is loaded (only if no profile data was loaded)
            // Remove the automatic draft loading to prevent conflicts
            // setTimeout(loadDraft, 1000);
        }

        // Load draft function
        function loadDraft() {
            const draft = localStorage.getItem('profileDraft');
            if (draft) {
                try {
                    const formData = JSON.parse(draft);
                    
                    // Only load draft if form is empty or user confirms
                    const isEmpty = !document.getElementById('first-name').value && 
                                   !document.getElementById('last-name').value;
                    
                    if (isEmpty || confirm('You have a saved draft. Would you like to load it?')) {
                        document.getElementById('first-name').value = formData.firstName || '';
                        document.getElementById('last-name').value = formData.lastName || '';
                        document.getElementById('age').value = formData.age || '';
                        document.getElementById('location').value = formData.location || '';
                        document.getElementById('height').value = formData.height || '';
                        document.getElementById('occupation').value = formData.occupation || '';
                        document.getElementById('about').value = formData.about || '';
                        document.getElementById('education').value = formData.education || '';
                        document.getElementById('relationship-status').value = formData.relationshipStatus || '';
                        document.getElementById('looking-for').value = formData.lookingFor || '';
                        
                        // Load interests
                        if (formData.interests) {
                            const interestCheckboxes = document.querySelectorAll('input[name="interests"]');
                            interestCheckboxes.forEach(checkbox => {
                                if (formData.interests.includes(checkbox.value)) {
                                    checkbox.checked = true;
                                    checkbox.nextElementSibling.classList.add('selected');
                                }
                            });
                        }
                        
                        showMessage('Draft loaded successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Error loading draft:', error);
                }
            }
        }

        // Utility function to show messages
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded border-2 border-black font-semibold z-50 ${
                type === 'success' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'
            }`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
